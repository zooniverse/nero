#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'

require 'mongo'
require 'json'

start_from = Time.new(2014, 1, 9)
total_to_do  = (ENV["AMOUNT"] || 1000000).to_i

Mongo::Logger.logger.level = Logger::FATAL

db = Mongo::Client.new(['127.0.0.1:27017'], database: 'ourobouros_spacewarp')
spacewarp_classifications = db["spacewarp_classifications"]
spacewarp_classifications.find({:created_at => {:$gt => start_from}}).sort(:created_at => 1).limit(total_to_do).each do |classification|
  puts JSON.dump \
    id: classification["_id"].to_s,
    annotations: classification["annotations"],
    links: {project: classification["project_id"].to_s,
            user: classification["user_id"].to_s,
            workflow: classification["workflow_id"].to_s,
            subjects: classification["subject_ids"].map(&:to_s)}
end
